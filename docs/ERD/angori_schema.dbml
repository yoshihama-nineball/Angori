## Angori ERå›³

Project angori {
  database_type: 'PostgreSQL'
  Note: '''
    Angori - ã‚´ãƒªãƒ©ã®ã‚¢ãƒ³ã‚¬ãƒ¼ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚¢ãƒ—ãƒª
    é–¢ä¿‚ç·šã®äº¤å·®ã‚’æœ€å°åŒ–ã™ã‚‹ãŸã‚ã®é †åºæœ€é©åŒ–
  '''
}

// ===============================
// ä¸­å¤®: Usersï¼ˆæœ€åˆã«é…ç½®ï¼‰
// ===============================

Table users {
  id bigint [primary key]
  email varchar [not null, unique]
  encrypted_password varchar [not null]
  name varchar [not null]
  reset_password_token varchar
  reset_password_sent_at timestamp
  remember_created_at timestamp
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆä¸­å¤®ï¼‰'
  
  Indexes {
    email [unique]
  }
}

// ===============================
// å·¦å´: 1å¯¾1é–¢ä¿‚ï¼ˆusersã®éš£ã«é…ç½®ï¼‰
// ===============================

Table calming_points {
  id bigint [primary key]
  user_id bigint [not null, unique]
  total_points integer [default: 0]
  current_level integer [default: 1]
  streak_days integer [default: 0]
  last_action_date date
  level_achievements jsonb
  milestone_flags jsonb
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸŒ ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå·¦å´ï¼‰'
  
  Indexes {
    user_id [unique]
    current_level
  }
}

// ===============================
// ä¸Šå´: ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿å…¥åŠ›
// ===============================

Table anger_logs {
  id bigint [primary key]
  user_id bigint [not null]
  anger_level integer [not null]
  situation text [not null]
  trigger_description text
  location varchar
  physical_reactions text
  occurred_at timestamp [not null]
  duration_minutes integer
  coping_method text
  reflection text
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸ˜¡ ã‚¢ãƒ³ã‚¬ãƒ¼ãƒ­ã‚°ï¼ˆä¸Šå´ï¼‰'
  
  Indexes {
    user_id
    occurred_at
    (user_id, occurred_at)
    anger_level
  }
}

// ===============================
// å³å´: AIå‡¦ç†ç³»ï¼ˆé€£é–é…ç½®ï¼‰
// ===============================

Table consultations {
  id bigint [primary key]
  user_id bigint [not null]
  anger_log_id bigint
  conversation_data jsonb [not null]
  ai_model varchar [default: 'gpt-4o-mini']
  session_status varchar [default: 'active']
  total_tokens_used integer [default: 0]
  started_at timestamp [not null]
  completed_at timestamp
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸ’¬ AIç›¸è«‡ï¼ˆå³ä¸Šï¼‰'
  
  Indexes {
    user_id
    anger_log_id
    started_at
    session_status
  }
}

Table ai_advices {
  id bigint [primary key]
  consultation_id bigint [not null]
  advice_content text [not null]
  advice_type varchar
  confidence_score float
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸ¤– AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆå³ä¸‹ï¼‰'
  
  Indexes {
    consultation_id
    advice_type
  }
}

// ===============================
// ä¸‹å´: åˆ†æç³»ï¼ˆæœ€å¾Œã«é…ç½®ï¼‰
// ===============================

Table trigger_words {
  id bigint [primary key]
  user_id bigint [not null]
  name varchar [not null]
  count integer [default: 1]
  anger_level_avg float
  category varchar
  last_triggered_at timestamp
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'âš¡ ãƒˆãƒªã‚¬ãƒ¼åˆ†æï¼ˆä¸‹å·¦ï¼‰'
  
  Indexes {
    (user_id, count)
    (user_id, name) [unique]
    category
  }
}

Table analytics {
  id bigint [primary key]
  user_id bigint [not null]
  analysis_type varchar [not null]
  analysis_date date [not null]
  data jsonb [not null]
  created_at timestamp [not null]
  updated_at timestamp [not null]
  
  Note: 'ğŸ“Š é«˜åº¦åˆ†æï¼ˆä¸‹å³ï¼‰'
  
  Indexes {
    (user_id, analysis_type, analysis_date) [unique]
  }
}

// ===============================
// é–¢ä¿‚æ€§å®šç¾©ï¼ˆé‡è¦åº¦é †ãƒ»ç·šäº¤å·®æœ€å°åŒ–ï¼‰
// ===============================

// ğŸ”¥ æœ€é‡è¦ï¼š1å¯¾1é–¢ä¿‚ï¼ˆå·¦å´ã®çŸ­ã„ç·šï¼‰
Ref: users.id - calming_points.user_id [delete: cascade]

// ğŸ“Š åŸºæœ¬ï¼šusersä¸­å¿ƒã®æ”¾å°„çŠ¶é–¢ä¿‚
Ref: users.id < anger_logs.user_id [delete: cascade]
Ref: users.id < consultations.user_id [delete: cascade]
Ref: users.id < trigger_words.user_id [delete: cascade]
Ref: users.id < analytics.user_id [delete: cascade]

// ğŸ¤– AIå‡¦ç†ï¼šå³å´ã®ç¸¦æ–¹å‘é€£é–
Ref: consultations.id < ai_advices.consultation_id [delete: cascade]

// ğŸ”— ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šä¸Šå³ã¸ã®æ–œã‚ç·š
Ref: anger_logs.id < consultations.anger_log_id [delete: set null]

// ===============================
// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆé…ç½®ãƒ’ãƒ³ãƒˆï¼‰
// ===============================

TableGroup "Core System" {
  users
  calming_points
}

TableGroup "Data Collection" {
  anger_logs
}

TableGroup "AI Processing" {
  consultations
  ai_advices
}

TableGroup "Analytics" {
  trigger_words
  analytics
}