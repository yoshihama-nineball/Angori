name: CD Pipeline

on:
  push:
    branches: [main, develop]

permissions:
  contents: read
  deployments: write

jobs:
  # ç’°å¢ƒè¨­å®šã¨ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®š
  setup:
    runs-on: ubuntu-latest
    outputs:
      is-production: ${{ steps.branch-check.outputs.is-production }}
      environment: ${{ steps.branch-check.outputs.environment }}
    steps:
    - name: Check branch and set environment
      id: branch-check
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "is-production=true" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "Production deployment triggered"
        else
          echo "is-production=false" >> $GITHUB_OUTPUT
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "Development deployment triggered"
        fi

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [setup]
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        cache-dependency-path: frontend/yarn.lock

    - name: Install dependencies
      working-directory: frontend
      run: yarn install --frozen-lockfile

    - name: Build application
      working-directory: frontend
      run: yarn build

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: ${{ needs.setup.outputs.is-production == 'true' && '--prod' || '' }}

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [setup]
    steps:
    - name: Deploy to Render
      run: |
        if [[ "${{ needs.setup.outputs.is-production }}" == "true" ]]; then
          echo "Triggering production backend deployment"
          # æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_PROD }}" || echo "Production deploy hook triggered"
        else
          echo "Triggering development backend deployment"
          # é–‹ç™ºç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_DEV }}" || echo "Development deploy hook triggered"
        fi

    - name: Wait for deployment
      run: |
        echo "Waiting for Render deployment to complete..."
        sleep 60

  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆç·©å’Œç‰ˆï¼‰
  verify:
    runs-on: ubuntu-latest
    needs: [setup, deploy-frontend, deploy-backend]
    steps:
    - name: Health check
      run: |
        if [[ "${{ needs.setup.outputs.is-production }}" == "true" ]]; then
          BACKEND_URL="https://angori.onrender.com"
          FRONTEND_URL="https://angori.vercel.app"
          echo "Checking Production environment"
          STRICT_CHECK=true  # æœ¬ç•ªç’°å¢ƒã¯å³æ ¼ã«ãƒã‚§ãƒƒã‚¯
        else
          BACKEND_URL="https://angori-api-development.onrender.com"
          FRONTEND_URL="https://angori-dev.vercel.app"
          echo "Checking Development environment"
          STRICT_CHECK=false  # é–‹ç™ºç’°å¢ƒã¯ç·©ã‚„ã‹ã«ãƒã‚§ãƒƒã‚¯
        fi
        echo "Backend URL: $BACKEND_URL"
        echo "Frontend URL: $FRONTEND_URL"
       
        # Wait for services to restart
        echo "Waiting for services to restart..."
        sleep 90
       
        # Backend health check
        echo "ğŸ” Starting backend health check..."
        max_attempts=5  # é–‹ç™ºç’°å¢ƒã¯å°‘ãªã„è©¦è¡Œå›æ•°
        attempt=1
        backend_healthy=false
       
        while [ $attempt -le $max_attempts ]; do
          echo "Backend health check attempt $attempt/$max_attempts"
         
          # è¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
          if curl -f -s --max-time 30 "$BACKEND_URL/health" > /dev/null 2>&1; then
            echo "âœ… Backend health check passed via /health!"
            backend_healthy=true
            break
          elif curl -f -s --max-time 30 "$BACKEND_URL/up" > /dev/null 2>&1; then
            echo "âœ… Backend health check passed via /up!"
            backend_healthy=true
            break
          elif curl -f -s --max-time 30 "$BACKEND_URL/" > /dev/null 2>&1; then
            echo "âœ… Backend health check passed via root!"
            backend_healthy=true
            break
          else
            echo "âŒ Backend health check failed, attempt $attempt/$max_attempts"
           
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
            echo "Response from $BACKEND_URL:"
            curl -s -w "HTTP Status: %{http_code}\n" "$BACKEND_URL/health" || echo "Connection failed"
           
            if [ $attempt -eq $max_attempts ]; then
              if [[ "$STRICT_CHECK" == "true" ]]; then
                echo "âŒ Production backend health check failed - CRITICAL!"
                exit 1
              else
                echo "âš ï¸  Development backend health check failed - continuing anyway"
                echo "Check Render dashboard manually: https://dashboard.render.com"
              fi
            fi
            sleep 30
            ((attempt++))
          fi
        done
        
        # Frontend health check
        echo "ğŸ” Starting frontend health check..."
        if curl -f -s --max-time 30 "$FRONTEND_URL" > /dev/null 2>&1; then
          echo "âœ… Frontend health check passed!"
        else
          echo "âŒ Frontend health check failed"
          if [[ "$STRICT_CHECK" == "true" ]]; then
            echo "âŒ Production frontend health check failed - CRITICAL!"
            exit 1
          else
            echo "âš ï¸  Development frontend might still be deploying"
          fi
        fi
        echo "ğŸ‰ Deployment verification completed!"
       
        # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        if [[ "$STRICT_CHECK" == "true" ]]; then
          echo "âœ… Production deployment verified successfully"
        else
          echo "âš ï¸  Development deployment completed (some checks may have failed)"
          echo "ğŸ’¡ Manual verification recommended for development environment"
        fi

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [setup, verify]
    if: always()
    steps:
    - name: Notify deployment status
      run: |
        if [[ "${{ needs.verify.result }}" == "success" ]]; then
          echo "âœ… Deployment to ${{ needs.setup.outputs.environment }} completed successfully!"
        else
          echo "âŒ Deployment to ${{ needs.setup.outputs.environment }} failed or had issues"
        fi